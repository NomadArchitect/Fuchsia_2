# Manifest File Formats Used by The Fuchsia Build System

The Fuchsia build system uses a number of "manifest" files that indicate how to
install files into containers, for instance copying them into [Fuchsia package
archives][fuchsia-package-archive], or into the boot filesystem image
of a [ZBI file][zbi-file].

This page documents these file formats which are used within the build, but
should not be exposed outside of it.

Note that the scripts and `.gni` files that generate and process these files
are located under `//build/dist/` in the Fuchsia source tree.

## FINI (Fuchsia INI) manifest file format {#fini-manifest}

The FINI manifest format is used by several tools invoked during the build: the
[`pm`][pm-tool] tool that generates Fuchsia package archives, or the
[`zbi`][zbi-tool] tool which generates ZBI images.

The syntax is very simple: each line of text looks like `<destination>=<source>`,
where `<destination>` is a destination file path, relative to the top of the
final container, and `<source>` is a file path to the source content, relative
to the current directory (i.e. the build directory in most cases).

Note that the destination path should _never_ begin with a directory separator,
and that FINI files do not support comments, sections, and other features of the
[Windows INI file format][windows-ini]{:.external}

For example:

```none {:.devsite-disable-click-to-copy}
bin/foo=foo
lib/ld.so.1=user.libc_x64/libc.so
meta/foo.cm=obj/src/foo/cml/foo_component/foo.cm
meta/package=gen/src/foo/foo_meta_package.txt
```


## Distribution manifest file format {#distribution-manifest}

This is a JSON file that must contain a list, where each item is a JSON object
as a single "distribution" entry, which describes how to install one
source file into a container, as well as provide a GN label for the target
that generated it. The schema used here is:

- `source`: A source path string (REQUIRED).

- `destination`: A destination path string (REQUIRED).

- `label`: A GN label pointing to the target that generated the source file.
   Only used for debugging (OPTIONAL).

Example:

```json {:.devsite-disable-click-to-copy}
  {
    "destination": "bin/foo",
    "source": "x64-asan/foo",
    "label": "//some/dir:foo"
  }
```

While conceptually similar to [FINI manifests](#fini-manifest), distribution
manifests provide a little bit more information (the GN label), which is highly
useful for debugging when things go wrong. They are also consumed by a different set
of tools.

## Partial distribution manifest file format {#partial-distribution-manifest}

[FINI](#fini-manifest) and [distribution manifests](#distribution-manifest)
are generated by processing intermediate files called "partial distribution manifests".

A partial manifest is generated by GN metadata collection over targets
in the same dependency tree. It is a JSON file that contains a list of
object "entries".

Several types of entries are used to describe various aspects of the
build and installation requirements. They are all merged into either a
FINI or distribution manifest.

The Python module at `//build/dist/distribution_manifest.py` contains
the functions used to process these files.

### Regular entries

These entries match the schema used for distribution manifests. They
correspond to a simple source file to install to a given destination
path.

When used to generate a distribution manifest, they are copied as-is
into the output file, unless they have the same source as another
regular entry (see [this section](#duplicate-entries) for details),
in which case only one of the entries is preserved.

Example:

```json {:.devsite-disable-click-to-copy}
  {
    "destination": "bin/foo",
    "source": "x64-asan/foo",
    "label": "//some/dir:foo"
  }
```

### File entries

These entries are used to include other distribution manifest files, which
may be generated by a different target. Their schema is:

- `file`: A file path string, pointing to another distribution manifest
  file (REQUIRED).

- `label`: A default GN label that will be applied to all entries in the
  included file, if they don't have their own `label` value (OPTIONAL).

Distribution file includes can be recursive.

Example:

```json {:.devsite-disable-click-to-copy}
  {
    "file": "path/to/other.dist_manifest",
    "label": "//some/dir:label"
  }
```

## Duplicate entries in manifest files {#duplicate-entries}

Due to the way the Fuchsia build works, it is possible for manifest files (of any
format) to provide multiple entries that use the same `<destination> `path. This is
however valid as long as the source paths, or their content, are identical; in which
case duplicates will simply be ignored.

The case where multiple entries have the same destination path, but different
source path _and_ content, is treated as a build error by the processing
scripts.

[windows-ini]: https://en.wikipedia.org/wiki/INI_file
[fuchsia-package-archive]: /docs/concepts/packages/package.md#structure-of-a-package
[zbi-file]: /docs/glossary.md#zircon-boot-image
[pm-tool]: /docs/reference/tools/sdk/pm.md
[zbi-tool]: /docs/reference/tools/sdk/zbi.md
